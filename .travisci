language: python
python:
  - 3.7

services:
  - docker

install:
  - docker build -t speedtest-exporter .
  - docker run -d -p 0.0.0.0:9102:9102 --name speedtest-exporter speedtest-exporter

before_script:
  - pip install requests

script:
  - docker ps | grep -q speedtest-exporter
  - python tests.py
  - docker logs speedtest-exporter 2>&1 | grep -c error || true

deploy:
  provider: script
  script: bash docker_push.sh
  on:
    branch: master
